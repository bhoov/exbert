!function(e){function t(t){for(var a,o,r=t[0],d=t[1],c=t[2],h=0,u=[];h<r.length;h++)o=r[h],Object.prototype.hasOwnProperty.call(i,o)&&i[o]&&u.push(i[o][0]),i[o]=0;for(a in d)Object.prototype.hasOwnProperty.call(d,a)&&(e[a]=d[a]);for(l&&l(t);u.length;)u.shift()();return n.push.apply(n,c||[]),s()}function s(){for(var e,t=0;t<n.length;t++){for(var s=n[t],a=!0,r=1;r<s.length;r++){var d=s[r];0!==i[d]&&(a=!1)}a&&(n.splice(t--,1),e=o(o.s=s[0]))}return e}var a={},i={0:0},n=[];function o(t){if(a[t])return a[t].exports;var s=a[t]={i:t,l:!1,exports:{}};return e[t].call(s.exports,s,s.exports,o),s.l=!0,s.exports}o.m=e,o.c=a,o.d=function(e,t,s){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(o.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)o.d(s,a,function(t){return e[t]}.bind(null,a));return s},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="";var r=window.webpackJsonp=window.webpackJsonp||[],d=r.push.bind(r);r.push=t,r=r.slice();for(var c=0;c<r.length;c++)t(r[c]);var l=d;n.push([85,1]),s()}({76:function(e,t){},77:function(e,t){},78:function(e,t){},79:function(e,t){},80:function(e,t){},81:function(e,t){},82:function(e,t,s){e.exports=s.p+"exBERT.html"},83:function(e,t,s){e.exports=s.p+"index.html"},84:function(e,t,s){},85:function(e,t,s){"use strict";s.r(t);var a,i,n,o=s(2),r=s(5),d=s(112),c=s(90),l=s(91),h=s(100),u=s(105),f=s(92);function p(e,t){return e<t?-1:e>t?1:0}function b(e,t){let s=[],a=r.findIndex(e,t,0);for(;-1!=a;)s.push(a),a=r.findIndex(e,t,a+1);return s}!function(e){e[e.ADDED=0]="ADDED",e[e.REMOVED=1]="REMOVED"}(a||(a={})),function(e){e[e.Row=0]="Row",e[e.Col=1]="Col",e[e.All=2]="All"}(i||(i={})),function(e){e.Bidirectional="bidirectional",e.Autoregressive="autoregressive"}(n||(n={})),o.m.prototype.clear=function(){return this.selectAll("*").remove(),this},o.m.prototype.toggleClass=function(e){return this.classed(e,!this.classed(e)),this},o.m.prototype.show=function(){return this.style("display","initial"),this},o.m.prototype.hide=function(){return this.style("display","none"),this},o.m.prototype.toggle=function(){var e="none"==this.style("display");return this.style("display",e?"inherit":"none")},o.m.prototype.after=function(e){var t=[];return this.each((function(){var s=document.createElement(e);this.parentNode.insertBefore(s,this.nextSibling),t.push(s)})),o.l(t)},o.m.prototype.before=function(e){var t=[];return this.each((function(){var s=document.createElement(e);this.parentNode.insertBefore(s,this),t.push(s)})),o.l(t)};var g=s(88),m=s(89);const v=[{text:"[SEP]",embeddings:[],contexts:[],bpe_token:"",bpe_pos:"",bpe_dep:"",bpe_is_ent:null,topk_words:[],topk_probs:[]}];class k{constructor(e=v,t=[]){this.tokenData=e,this.maskInds=t}mask(e){-1==r.indexOf(this.maskInds,e)?function(e,t,s=!1){s&&e.sort(p),function(e,t,s){e.splice(s,0,t)}(e,t,r.sortedIndex(e,t))}(this.maskInds,e):(console.log(`${e} already in maskInds!`),console.log(this.maskInds))}toggle(e){-1==r.indexOf(this.maskInds,e)?(console.log(`Masking ${e}`),this.mask(e)):(console.log(`Unmasking ${e}`),this.unmask(e))}unmask(e){r.pull(this.maskInds,e)}resetMask(){this.maskInds=[]}length(){return this.tokenData.length}concat(e){const t=r.concat(this.tokenData,e.tokenData),s=r.concat(this.maskInds,e.maskInds.map(e=>e+this.length()));return new k(t,s)}}class x{constructor(e){this.updateFromResponse(e)}updateFromResponse(e){const t=e.aa.left;this.updateFromComponents(t,[])}updateFromComponents(e,t){this.a=new k(e,t)}updateTokens(e){const t=["contexts","embeddings","topk_probs","topk_words"],s=e.aa.left.map(e=>g.a(t,e));m.a(this.a.tokenData,s).forEach((e,t)=>{Object.keys(e[1]).map(t=>{e[0][t]=e[1][t]})})}mask(e,t){this[e].mask(t);this.a.length()}}const y={"527fdac4404bf9ba5412646ad457950d4482762c":"527fdac4404bf9ba5412646ad457950d4482762c.json","59b4acc05f1d80ecbef1c23eaf2fda10222cb257":"59b4acc05f1d80ecbef1c23eaf2fda10222cb257.json","354992f2ee236604c874a3a627e4042bc68586f8":"354992f2ee236604c874a3a627e4042bc68586f8.json","5015e5a318605cea6808538db14d8af16887b076":"5015e5a318605cea6808538db14d8af16887b076.json","3c9aa152ac894306040703c5095599b199cad1a9":"3c9aa152ac894306040703c5095599b199cad1a9.json","0fece0c87203e83afd1674b5aeebaed0f5fa0562":"0fece0c87203e83afd1674b5aeebaed0f5fa0562.json",d3a0e4045ea48a275ce51a6af0280406060f47cf:"d3a0e4045ea48a275ce51a6af0280406060f47cf.json",ed98d751ab9b6a4a0e85e9332b420a4c13ab75a7:"ed98d751ab9b6a4a0e85e9332b420a4c13ab75a7.json","0d24ae08eeb21af82c666cbe2ac0646ed9c9d9a6":"0d24ae08eeb21af82c666cbe2ac0646ed9c9d9a6.json","6de053b3b8a4d904780c9a6545a0a63cbbb2b144":"6de053b3b8a4d904780c9a6545a0a63cbbb2b144.json",f68df23365faf02f9c01439345bed66936ed85f7:"f68df23365faf02f9c01439345bed66936ed85f7.json","4608cb4fc00b43fff68098e85676fad57c940f02":"4608cb4fc00b43fff68098e85676fad57c940f02.json",dfcd50146da8d8122a5a57c2a3c0abce503ba94b:"dfcd50146da8d8122a5a57c2a3c0abce503ba94b.json","34c8629d4265d7f3ede3add42f3613b205d94c1c":"34c8629d4265d7f3ede3add42f3613b205d94c1c.json",db2dc252a786650f64395a0f5d181c0831019cbf:"db2dc252a786650f64395a0f5d181c0831019cbf.json",da4597d73d444757bde9176395bf31aad3334131:"da4597d73d444757bde9176395bf31aad3334131.json",a2ebf13d3c9371fcf738b9651824e2c3cd1ff8e0:"a2ebf13d3c9371fcf738b9651824e2c3cd1ff8e0.json",bc419238c20dd1c5cfe1cc427ab3d1e31353436a:"bc419238c20dd1c5cfe1cc427ab3d1e31353436a.json","84e8be9fe562fbd0487c03b55cc6b4f3fb8cd787":"84e8be9fe562fbd0487c03b55cc6b4f3fb8cd787.json","207e6c98a0e149dc7e6ed67118296d8a8c89b3c3":"207e6c98a0e149dc7e6ed67118296d8a8c89b3c3.json",c185a9349ba5a325acf8514e9b50de71280488aa:"c185a9349ba5a325acf8514e9b50de71280488aa.json",dde481a5cd3667ae8c6c5b5e1421dc882b6a2dd6:"dde481a5cd3667ae8c6c5b5e1421dc882b6a2dd6.json",f63e14e935d98948b4a0ebc9663400dbe4263348:"f63e14e935d98948b4a0ebc9663400dbe4263348.json","79b964d1a5c854deaeace26813f96994bb82aef2":"79b964d1a5c854deaeace26813f96994bb82aef2.json","3b1168ec96af00c4e887341e92a878f8752e1d17":"3b1168ec96af00c4e887341e92a878f8752e1d17.json","8c462bc298e3183efa8d9e863e25ea5d89806b03":"8c462bc298e3183efa8d9e863e25ea5d89806b03.json","9939698edaa25bbae9ee1d27864e698f13963f06":"9939698edaa25bbae9ee1d27864e698f13963f06.json","73f1ee497b3e7b6394e55726b18dbf9d514dcea6":"73f1ee497b3e7b6394e55726b18dbf9d514dcea6.json",c7cdb80bf813e1de241260aede6cd28ea65ccfae:"c7cdb80bf813e1de241260aede6cd28ea65ccfae.json",a96fed16eab1bf6d08e4001c02894d9c549df627:"a96fed16eab1bf6d08e4001c02894d9c549df627.json",a8eaf10da8dc75b42e72bdc7091776247fff9657:"a8eaf10da8dc75b42e72bdc7091776247fff9657.json",a8194f2309e1c71e977ef8d3be572ae00b0e91f2:"a8194f2309e1c71e977ef8d3be572ae00b0e91f2.json","2f4a15b66fcfb0c7a43a33d93763990282bfc5aa":"2f4a15b66fcfb0c7a43a33d93763990282bfc5aa.json","06095cef4a7f49b18f153e67e33fddb831a15b46":"06095cef4a7f49b18f153e67e33fddb831a15b46.json","4c93eaf0c0ce56f1e5d5100916abf4d31eb35da5":"4c93eaf0c0ce56f1e5d5100916abf4d31eb35da5.json",f8c40c67c851a0489f7480c99b31b4f606c0184b:"f8c40c67c851a0489f7480c99b31b4f606c0184b.json",e4e71f6ea57be2e05d62af0825a80f144421e02d:"e4e71f6ea57be2e05d62af0825a80f144421e02d.json",e7d9d520882782c7cfbffeadaaf22b4c0a081c7c:"e7d9d520882782c7cfbffeadaaf22b4c0a081c7c.json","4aa4eb10ead44a0a3c2dd95407017a928138b32b":"4aa4eb10ead44a0a3c2dd95407017a928138b32b.json",da31d55ee8cb01bcdb29572cb902b8e799685be2:"da31d55ee8cb01bcdb29572cb902b8e799685be2.json",e427181fb02bbf19f7bbb65c9d9389d2d9a41812:"e427181fb02bbf19f7bbb65c9d9389d2d9a41812.json",bbcab9e1ca60a851fd7ecfda80de470afa740936:"bbcab9e1ca60a851fd7ecfda80de470afa740936.json","4de96aa205076863c9fb4ea99e2ba86fa131ff76":"4de96aa205076863c9fb4ea99e2ba86fa131ff76.json",e4c6d1b3004e3cdd0c879a59639b5ce993207a99:"e4c6d1b3004e3cdd0c879a59639b5ce993207a99.json",fbc9da79b8bf39dc9998408526741f811a13e6aa:"fbc9da79b8bf39dc9998408526741f811a13e6aa.json","528554ee4e615c61287c40ed9a2aea69b91af6c9":"528554ee4e615c61287c40ed9a2aea69b91af6c9.json","5e7073c03c37d19826b2fb4a6599ccaedde492e4":"5e7073c03c37d19826b2fb4a6599ccaedde492e4.json","71c4a886cdee58a371ae2115311b150e84e555f6":"71c4a886cdee58a371ae2115311b150e84e555f6.json","4bce0970a465fe9b96305e06af19c5d9c97d7cc3":"4bce0970a465fe9b96305e06af19c5d9c97d7cc3.json",efdb1f0a70f22f80ff3cea0cb79bec717fc8b6f7:"efdb1f0a70f22f80ff3cea0cb79bec717fc8b6f7.json","174c6f786d139ce111381045d60d25682a168b99":"174c6f786d139ce111381045d60d25682a168b99.json",a8c23e88d6ca6d4efd2646b0742c0fa32dbd55a4:"a8c23e88d6ca6d4efd2646b0742c0fa32dbd55a4.json",f6949c28752de35a870efde308585acd46a25278:"f6949c28752de35a870efde308585acd46a25278.json",c1bdb8cbafd5d5d8f6bda2b4db16b6bc2d62e18a:"c1bdb8cbafd5d5d8f6bda2b4db16b6bc2d62e18a.json","2b81a8f602251cf40b4682c8cedb3966b912d7c6":"2b81a8f602251cf40b4682c8cedb3966b912d7c6.json","8f94e843d2510047fd1af46f249afe87ff49cc2f":"8f94e843d2510047fd1af46f249afe87ff49cc2f.json","4e3ddb51550c03c64fdbe5592526665100d32930":"4e3ddb51550c03c64fdbe5592526665100d32930.json",f816b23af9aa4312c80e668a66a156c934cb330c:"f816b23af9aa4312c80e668a66a156c934cb330c.json","2fe05a911a574b8a6d4b05eb13db9e09aaacad2d":"2fe05a911a574b8a6d4b05eb13db9e09aaacad2d.json","5c71496726395aaa4d0a65373fd1651b5a0e6b1f":"5c71496726395aaa4d0a65373fd1651b5a0e6b1f.json"};var C=s(33);function _(e,t){if(t){let s=e+"?";return Object.keys(t).forEach(e=>{s+=e,s+="=",s+=t[e],s+="&"}),s.replace(/&$/g,"")}return e}const w=e=>({method:"POST",body:JSON.stringify(e),headers:{"Content-type":"application/json; charset=UTF-8"}});class M{static basicURL(){const e=window.location.pathname.split("/").slice(0,-2).join("/");return window.location.origin+(e.length?e:"")}static get parameters(){const e=window.location.search.substring(1).split("&");console.log(e,"--- vars");const t={},s=e=>(e=>/^[0-9]+$/.test(e))(e)?Number.parseInt(e,10):(e=>/^[0-9]+\.[0-9]*$/.test(e))(e)?Number.parseFloat(e):e;return e.forEach(e=>{if(e.length>0){const a=e.split("="),i=decodeURIComponent(a[0]);let n=decodeURIComponent(a[1]);const o=n.startsWith("..");o&&(n=n.slice(2)),n.length<1?t[i]=o?[]:"":t[i]=o?n.split(",").map(e=>s(e)):s(n)}}),t}static urlString(e){const t=[];Object.keys(e).forEach(s=>{const a=e[s];if(void 0!==a){let e=a;Array.isArray(a)&&(e=".."+a.join(",")),t.push(encodeURI(s+"="+e))}});const s=window.location.pathname;let a=s.substring(s.lastIndexOf("/")+1);return t.length>0&&(a+="?"+t.join("&")),a}static updateURLParam(e,t,s=!0){const a=M.parameters;a[e]=t,M.updateUrl(a,s)}static updateUrl(e,t=!0){t?window.history.pushState(e,"",M.urlString(e)):window.history.replaceState(e,"",M.urlString(e))}}new k;const S=M.basicURL();function H(e,t=null,s=null){if(!e.ok){if(null!=t)return console.log("STATIC FILE NOT FOUND"),fetch(t,s).then(H);throw new Error(e.status+" "+e.statusText)}return e.json()}function I(e,t=null,s=null){const a=C.sha1(e);if(console.log("CHECKING DEMOAPI: "+a),y.hasOwnProperty(a)){const e="./demo/"+y[a];console.log("TRYING TO SENDING STATIC: ",e);const i=e=>H(e,t,s);return fetch(e).then(i)}return o.c(t,s)}class j{constructor(e=null){this.baseURL=e,null==this.baseURL&&(this.baseURL=S+"/api")}getModelDetails(e,t=null){const s={model:e},a=_(this.baseURL+"/get-model-details",s);if(console.log("--- GET "+a),null!=t){const e=C.sha1(s);o.c(a).then(s=>{t[e]=s})}return I(s,a)}getSupportedModels(){const e=_(this.baseURL+"/supported-models",{});return o.c(e)}getSupportedCorpora(){const e=_(this.baseURL+"/supported-corpora",{});return o.c(e)}getMetaAttentions(e,t,s,a=null){const i={model:e,sentence:t,layer:s},n=_(this.baseURL+"/attend-with-meta",i);if(console.log("--- GET "+n),null!=a){const e=C.sha1(i);o.c(n).then(t=>{a[e]=t})}return I(i,n)}updateMaskedAttentions(e,t,s,a,i=null){const n={model:e,tokens:d.a(c.a("text"),t.tokenData),sentence:s,mask:t.maskInds.length?t.maskInds:[-1],layer:a},r=_(this.baseURL+"/update-mask"),l=w(n);if(null!=i){const e=C.sha1(n);o.c(r,l).then(t=>{i[e]=t})}return console.log("--- POST "+r,l),I(n,r,l)}getNearestEmbeddings(e,t,s,a,i,n=10,r=null){const d={model:e,corpus:t,embedding:s,layer:a,heads:i,k:n},c=_(this.baseURL+"/k-nearest-embeddings"),l=w(d);if(console.log("--- GET "+c),null!=r){const e=C.sha1(d);o.c(c).then(t=>{r[e]=t})}return I(d,c,l)}getNearestContexts(e,t,s,a,i,n=10,r=null){const d={model:e,corpus:t,embedding:s,layer:a,heads:i,k:n},c=_(this.baseURL+"/k-nearest-contexts"),l=w(d);if(console.log("--- GET "+c),null!=r){const e=C.sha1(d);o.c(c).then(t=>{r[e]=t})}return I(d,c,l)}}var A=s(66);const O=e=>!(e=>new Set(["false",0,"no",!1,null,""]).has(e))(e),T=e=>+e;class D{constructor(){this._conf={},this._nHeads=12,this._nLayers=null,this.attType="aa",this.fromURL(),this.toURL(!1)}fromURL(){const e=M.parameters;this._conf={model:e.model||"bert-base-cased",modelKind:e.modelKind||n.Bidirectional,sentence:e.sentence||"The girl ran to a local pub to escape the din of her city.",corpus:e.corpus||"woz",layer:e.layer||0,heads:this._initHeads(e.heads),threshold:e.threshold||.7,tokenInd:e.tokenInd||null,tokenSide:e.tokenSide||null,maskInds:e.maskInds||[9],metaMatch:e.metaMatch||"pos",metaMax:e.metaMax||"pos",displayInspector:e.displayInspector||null,offsetIdxs:this._initOffsetIdxs(e.offsetIdxs),hideClsSep:O(e.hideClsSep)||!0},this._token={side:this._conf.tokenSide,ind:this._conf.tokenInd}}toURL(e=!1){M.updateUrl(this._conf,e)}_initOffsetIdxs(e){if(null==e)return[-1,0,1];return d.a(T,e)}_initHeads(e){return null==e||e.length<1?this.selectAllHeads():console.log(this.headSet(new Set(e))._conf.heads),this.heads()}nHeads(e){return null==e?this._nHeads:(this._nHeads=e,this)}nLayers(e){return null==e?this._nLayers:(this._nLayers=e,this)}toggleSelectAllHeads(){0==this.heads().length?this.selectAllHeads():this.selectNoHeads()}selectAllHeads(){this.headSet(new Set(r.range(0,this._nHeads)))}selectNoHeads(){this.headSet(new Set([]))}toggleHead(e){let t;return this.headSet().has(e)?(this.headSet().delete(e),t=a.REMOVED):(this.headSet().add(e),t=a.ADDED),this.headSet(this.headSet()),t}toggleToken(e){const t=g.a(["ind","side"]),s=t(e),a=t(this.token());return A.a(a,s)?this.rmToken():this.token(e),this}token(e){return null==e?this._token:(this._token=e,this._conf.tokenInd=e.ind,this._conf.tokenSide=e.side,this.toURL(),this)}hasToken(){const e=this._conf,t=null==e.tokenInd&&null==e.tokenSide,s="null"==e.tokenInd;return!t&&!s}rmToken(){return this.token({ind:null,side:null}),this}sentence(e){return null==e?this._conf.sentence:(this._conf.sentence=e,this.toURL(!0),this)}threshold(e){return null==e?this._conf.threshold:(this._conf.threshold=e,this.toURL(),this)}heads(){return this._conf.heads}layer(e){return null==e?this._conf.layer:(this._conf.layer=e,this.toURL(),this)}headSet(e){return null==e?this._headSet:(this._headSet=e,this._conf.heads=(t=this._headSet,Array.from(t).sort(p)),this.toURL(),this);var t}metaMatch(e){return null==e?this._conf.metaMax:(this._conf.metaMax=e,this.toURL(),this)}metaMax(e){return null==e?this._conf.metaMatch:(this._conf.metaMatch=e,this.toURL(),this)}maskInds(e){return null==e?this._conf.maskInds:(this._conf.maskInds=e,this.toURL(),this)}displayInspector(e){return null==e?this._conf.displayInspector:(this._conf.displayInspector=e,this.toURL(),this)}offsetIdxs(e){return null==e?this._conf.offsetIdxs:(this._conf.offsetIdxs=d.a(T,e),this.toURL(),this)}hideClsSep(e){return null==e?this._conf.hideClsSep:(this._conf.hideClsSep=O(e),this.toURL(),this)}model(e){return null==e?this._conf.model:(this._conf.model=e,this.toURL(),this)}modelKind(e){return null==e?this._conf.modelKind:(this._conf.modelKind=e,this.toURL(),this)}get offset(){switch(this.modelKind()){case n.Bidirectional:case n.Autoregressive:default:return 0}}get showNext(){return this.modelKind()==n.Autoregressive}get matchHistogramDescription(){return this.modelKind()==n.Autoregressive?"Next":"Matched"}corpus(e){return null==e?this._conf.corpus:(this._conf.corpus=e,this.toURL(),this)}}var E=s(113);let R=0;class N{static simpleUId({prefix:e=""}){return e+(R+=1)}}class L{}L.setSelVisible=e=>e.attr("visibility","visible"),L.setSelHidden=e=>e.attr("visibility","hidden"),L.setVisible=e=>L.setSelVisible(o.l(e)),L.setHidden=e=>L.setSelHidden(o.l(e)),L.hideElement=e=>e.transition().styles({opacity:0,"pointer-events":"none",display:"none"}),L.unhideElement=e=>e.transition().styles({opacity:1,"pointer-events":null,display:null});class z{constructor(e){this.element=e,this.eventListeners=[]}bind(e,t){for(const s of e.split(" ")){this.eventListeners.push({eventName:s,eventFunction:t});const e=e=>t(e.detail,e);this.element.addEventListener(s,e,!1)}}getListeners(){return this.eventListeners}trigger(e,t){this.element.dispatchEvent(new CustomEvent(e,{detail:t}))}}s(61);class ${static translate({x:e,y:t}){return"translate("+e+","+t+")"}static rotate(e){return`rotate(${e})`}static group(e,t,s={x:0,y:0}){return e.append("g").attrs({class:t,transform:$.translate(s)})}}class W{constructor(e,t){this.id=N.simpleUId({}),this.parent=e,this.eventHandler=t||new z(this.parent.node()),this._visibility={hidden:!1}}superInitHTML(e={}){Object.keys(e).forEach(t=>this.options[t]=e[t]),this.base=this.parent.append("div").classed(this.css_name,!0)}superInitSVG(e={},t=["bg","main","fg"]){Object.keys(e).forEach(t=>this.options[t]=e[t]),this.layers={};const s=this.parent;this.base=$.group(s,this.css_name+" ID"+this.id,this.options.pos),t&&t.forEach(e=>{this.layers[e]=$.group(this.base,e)})}update(e){this._data=e,this._visibility.hidden||(this.renderData=this._wrangle(e),this._render(this.renderData))}updateOptions({options:e,reRender:t=!1}){Object.keys(e).forEach(t=>this.options[t]=e[t]),t&&this._render(this.renderData)}redraw(){this._render(this.renderData)}setHideElement(e){this._visibility.hideElement=e}hideView(){if(!this._visibility.hidden){(this._visibility.hideElement||this.parent).transition().styles({opacity:0,"pointer-events":"none"}).style("display","none"),this._visibility.hidden=!0}}unhideView(){if(this._visibility.hidden){(this._visibility.hideElement||this.parent).transition().styles({opacity:1,"pointer-events":null,display:null}),this._visibility.hidden=!1}}destroy(){this.base.remove()}clear(){this.base.html("")}}W.events={noEvent:"VComponent_noEvent"};class U extends W{constructor(e,t,s={}){super(e,t),this.eInfo=(e,t)=>({sel:e,side:this.side,ind:t}),this.eEmbedding=(e,t,s)=>({sel:e,side:this.side,ind:t,embeddings:s}),this.options={boxheight:26,offset:0,divHover:{width:150,height:150,offset:[3,3],textInfo:"Would predict..."}},this.superInitHTML(s)}mask(e){this.parent.selectAll(`.${this.css_name}`).each((t,s,a)=>{o.k(a[s]).classed("masked-token",r.includes(e,s))})}getEmbedding(e){return this._data[e]}_init(){}_wrangle(e){return this.data=this._data,this._data}_divPlacement(){const e=this,t=this.options,s=o.f(e.base.node()),a=[3,3];return[s[0]+(()=>e.base.node().getBoundingClientRect().left)()-(t.divHover.width+a[0]),s[1]+(()=>e.base.node().getBoundingClientRect().top)()+a[1]]}_render(e){const t=this.options,s=this;this.base.selectAll("*").remove(),this.divHover=this.base.append("div").classed("tok-info",!0).classed("mat-hover-display",!0).classed(this.hover_css_name,!0).style("width",String(this.options.divHover.width)+"px").style("height",String(this.options.divHover.height)+"px"),this.divHover.append("p").classed("p-info",!0).style("font-weight","bold").text(t.divHover.textInfo),console.log(`Internal offset (${this.side}): `,t.offset),this.base.selectAll(".blank-text-box").data(E.a(0,t.offset)).join("div").classed("blank-text-box",!0).classed("token",!0).style("height",t.boxheight+"px").text(e=>"  "),s.textBoxes=this.base.selectAll(`.${this.css_name}`).data(e).join("div").attr("class",(e,t)=>`token ${this.css_name} token-${t}`).attr("id",(e,t)=>`${this.css_name}-${t}`).style("height",t.boxheight+"px").text(e=>e.text.replace("Ġ"," ").replace("Ċ","\\n")).on("mouseover",(function(e,t){const a=o.k(this);a.style("background","lightblue"),s.eventHandler.trigger(U.events.tokenMouseOver,s.eInfo(a,t)),s.divHover.style("visibility","visible")})).on("mouseout",(function(e,t){let a=o.k(this);a.style("background",0),s.eventHandler.trigger(U.events.tokenMouseOut,s.eInfo(a,t)),s.divHover.style("visibility","hidden")})).on("mousemove",(function(e,t){o.k(this);const[a,i]=s._divPlacement();s.divHover.style("left",String(a)+"px").style("top",String(i)+"px").selectAll(".topk-word-box").data(o.o(e.topk_words,e.topk_probs)).join("p").classed("topk-word-box",!0).text(e=>{return e[0].replace(/\u0120/g," ").replace(/\u010A/g,"\\n")+": "+e[1].toFixed(2)})})),s.addClick(s.textBoxes)}addClick(e){const t=this;t.textBoxes=e.on("click",(e,s,a)=>{const i=o.k(a[s]);t.eventHandler.trigger(U.events.tokenClick,t.eEmbedding(i,s,e.embeddings))}).on("dblclick",(e,s,a)=>{const i=o.k(a[s]);t.eventHandler.trigger(U.events.tokenDblClick,t.eInfo(i,s))})}}U.events={tokenMouseOver:"TextToken_TokenMouseOver",tokenMouseOut:"TextToken_TokenMouseOut",tokenClick:"TextToken_TokenClick",tokenDblClick:"TextToken_TokenDblClick"};class B extends U{constructor(e,t,s={}){super(e,t),this.css_name="left-token",this.hover_css_name="left-token-hover",this.side="left",this.offset=1}}class P extends U{constructor(e,t,s={}){super(e,t),this.css_name="right-token",this.hover_css_name="right-token-hover",this.side="right",this.offset=0}_divPlacement(){const e=this,t=(this.options,o.f(e.base.node())),s=[3,3];return[t[0]+(()=>e.base.node().getBoundingClientRect().left)()+s[0],t[1]+(()=>e.base.node().getBoundingClientRect().top)()+s[1]]}}var F=s(30);function V(e,t,s="left",a=null){if(0==t.length)return{rows:[[]],labels:[],max:0};let i=null;null!=a&&a.side!=s&&(i="left"==a.side?-2:-1);let n="left"==s?2:1,o=F.b(e);null!=i&&(o=o.gather([a.ind],i));let r=o.gather(t,0).mean([n]).transpose();return{rows:r.arraySync(),labels:t,max:r.max().arraySync()}}class G extends W{constructor(e,t,s={}){super(e,t),this.css_name="",this.rowCssName="att-head",this.boxCssName="att-rect",this._current={},this.options={boxDim:26,yscale:1,xscale:.5,side:"left",maxWidth:200,offset:0},this.superInitSVG(s),this._init()}_init(){this.headRows=this.base.selectAll(`.${this.rowCssName}`),this.headCells=this.headRows.selectAll(`${this.boxCssName}`),this.opacityScale=o.h().range([0,1])}updateCurrent(){const e=this.options,t=this._current,s=this._data.rows[0].length,a=e.boxDim*e.xscale;t.headHeight=e.boxDim*e.yscale,t.headWidth=(t=>Math.min(e.maxWidth/t,a)/a*e.xscale)(s)*e.boxDim,t.xPad=t.headWidth,t.yPad=(e.boxDim-t.headHeight)/2;return t.boxWidth=this._data.rows[0].length*t.headWidth,t.totalWidth=2*t.xPad+t.boxWidth,t.totalHeight=e.boxDim*(this._data.rows.length+e.offset),this._current}updateData(){const e=this.options,t=this,s=s=>({ind:s,side:e.side,head:t._data.labels[s]}),a=this.updateCurrent(),i=()=>t.base.node().getBoundingClientRect().left,n=()=>t.base.node().getBoundingClientRect().top;this.base.html(""),this.parent.attr("width",a.totalWidth).attr("height",a.totalHeight),this.headRows=this.base.selectAll(`.${t.rowCssName}`).data(t._data.rows).join("g").attrs({class:(e,s)=>`${t.rowCssName} ${t.rowCssName}-${s}`,transform:(t,s)=>$.translate({x:a.xPad,y:e.boxDim*(s+e.offset)+a.yPad}),width:a.boxWidth,height:a.headHeight}).on("mouseover",(s,a)=>{t.eventHandler.trigger(G.events.rowMouseOver,{ind:a,side:e.side})}).on("mouseout",(s,a)=>{t.eventHandler.trigger(G.events.rowMouseOut,{ind:a,side:e.side})}),this.headCells=this.headRows.selectAll(`${this.boxCssName}`).data(e=>e).join("rect").attrs({x:(e,t)=>t*a.headWidth,y:0,class:this.boxCssName,head:(e,s)=>t._data.labels[s],width:a.headWidth,height:a.headHeight,opacity:e=>this.opacityScale(e),fill:"blue"}).on("mouseover",(e,a)=>{t.eventHandler.trigger(G.events.boxMouseOver,s(a))}).on("mouseout",(e,a)=>{t.eventHandler.trigger(G.events.boxMouseOut,s(a))}).on("click",(e,a)=>{t.eventHandler.trigger(G.events.boxClick,s(a))}).on("mousemove",(function(e,s){const a=t.options,r=o.f(t.base.node());t.eventHandler.trigger(G.events.boxMouseMove,{ind:s,side:a.side,baseX:i(),baseY:n(),mouse:r})})).append("svg:title").text((e,s)=>"Head "+(t._data.labels[s]+1))}_wrangle(e){return this._data=e,this.opacityScale=this.opacityScale.domain([0,e.max]),e}_render(e){this.updateData()}}G.events={rowMouseOver:"AttentionHeadBox_RowMouseOver",rowMouseOut:"AttentionHeadBox_RowMouseOut",boxMouseOver:"AttentionHeadBox_BoxMouseOver",boxMouseOut:"AttentionHeadBox_BoxMouseOut",boxMouseMove:"AttentionHeadBox_BoxMouseMove",boxClick:"AttentionHeadBox_BoxClick"};s(4);class K{constructor(e){this.data=e,this.tensData=F.a(e)}min(e){return this.tensData.min(e).dataSync()}max(e){return this.tensData.max(e).dataSync()}extent(e){return o.o(this.min(e),this.max(e))}format(e=.7){return function(e,t=1){let s,a=[];return e.forEach((e,i)=>{s=t*o.n(e);let n=0;const r=function(e,t){t||(t=function(e,t){return e[0]>t[0]?-1:1});let s={arr:[],sortIndices:[]},a=[];for(let t=0;t<e.length;t++)a[t]=[e[t],t];a.sort((function(e,t){return e[0]>t[0]?-1:1}));for(var i=0;i<e.length;i++)s.sortIndices.push(a[i][1]),s.arr[i]=a[i][0];return s}(e);r.arr.forEach((e,t)=>{if(n<s){const s={i:i,j:r.sortIndices[t],v:e};a.push(s),n+=e}})}),a}(this.data,e)}}const q=e=>5*e^.33;class Q extends W{constructor(e,t,s={}){super(e,t),this.css_name="",this._threshold=.7,this.options={boxheight:26,height:500,width:200,offset:0},this.createScales=()=>{this.opacityScales=[];let e=[];switch(this.normBy){case i.Row:e=this.edgeData.extent(1),this.opacityScales=[],e.forEach((e,t)=>{this.opacityScales.push(o.h().domain([0,e[1]]).range([0,.9]))});break;case i.Col:e=this.edgeData.extent(0),this.opacityScales=[],e.forEach((e,t)=>{this.opacityScales.push(o.h().domain([0,e[1]]).range([0,.9]))});break;case i.All:const t=o.e(this.plotData.map(e=>e.v));for(let e=0;e<this._data.length;e++)this.opacityScales.push(o.h().domain([0,t]).range([0,1]));break;default:console.log("Nor norming specified")}},this.superInitSVG(s),this._init()}_init(){this.svg=this.parent,this.graph=this.svg.selectAll(".atn-curve"),this.linkGen=o.d().x(e=>e[0]).y(e=>e[1])}scaleIdx(){switch(this.normBy){case i.Col:return"j";case i.Row:case i.All:return"i"}}createConnections(){const e=this.options;this.paths&&this.paths.attrs({d:(t,s)=>{const a={source:[0,e.boxheight*(t.i+.5+e.offset)],target:[e.width,e.boxheight*(t.j+.5)]};return this.linkGen(a)},class:"atn-curve"}).attr("src-idx",(e,t)=>e.i).attr("target-idx",(e,t)=>e.j)}updateHeight(){const e=this.options;return null!=this.svg&&this.svg.attr("height",this.options.height+e.offset*this.options.boxheight),this}updateWidth(){return null!=this.svg&&this.svg.attr("width",this.options.width),this}updateOpacity(){const e=this;return null!=this.paths&&(this.paths.attr("opacity",t=>{return this.opacityScales[t[e.scaleIdx()]](t.v)}),this.paths.attr("stroke-width",t=>{const s=this.opacityScales[t[e.scaleIdx()]](t.v);return q(s)})),this}updateData(){if(null!=this.graph){o.l(".atn-curve").remove();const e=this.plotData;return this.paths=this.graph.data(e).join("path"),this.createConnections(),this.updateOpacity(),this}}data(e){return null==e?this._data:(this._data=e,this.edgeData=new K(e),this.plotData=this.edgeData.format(this._threshold),this.createScales(),this.updateData(),this)}height(e){return null==e?this.options.height:(this.options.height=e,this.updateHeight(),this)}width(e){return null==e?this.options.width:(this.options.width=e,this.updateWidth(),this)}threshold(e){return null==e?this._threshold:(this._threshold=e,this.plotData=this.edgeData.format(this._threshold),this.createScales(),this.updateData(),this)}_wrangle(e){return e}_render(e){return this.svg.html(""),this.updateHeight(),this.updateWidth(),this.updateData(),this}}Q.events={};const X=e=>+e.parentNode.getAttribute("matchidx"),Y=e=>+e.parentNode.getAttribute("rownum"),Z=e=>`rgba(128, 0, 150, ${.6*e})`;class J extends W{constructor(e,t,s={}){super(e,t),this.css_name="corpus-inspector",this.options={showNext:!1},this.scaler=o.j().range([0,.9]).exponent(2),this.superInitHTML(s),this._init()}createRows(){const e=this._data;this.inspectorRows=this.base.selectAll(".inspector-row").data(e).join("div").classed("inspector-row",!0).attrs({matchIdx:e=>e.index,rowNum:(e,t)=>t}).on("mouseover",(e,t)=>{this.eventHandler.trigger(J.events.rowMouseOver,{})})}addTooltip(){this.inspectorCells=this.inspectorCells.classed("celltooltip",!0).append("span").classed("tooltiptext",!0).html((e,t,s)=>{const a=e.is_ent?"<br>Entity":"",i=`<br>Attention: ${s[t].parentNode.getAttribute("att").slice(0,7)}`;return`POS: ${e.pos.toLowerCase()}<br>DEP: ${e.dep.toLowerCase()}`+a+i})}createCells(){const e=this;this.inspectorCells=this.inspectorRows.selectAll(".inspector-cell").data(e=>e.tokens).join("div").classed("inspector-cell",!0).attr("index-offset",(e,t,s)=>{return t-X(s[t])}).attrs({pos:e=>e.pos.toLowerCase(),dep:e=>e.dep.toLowerCase(),is_ent:e=>e.is_ent}).text(e=>e.token.replace("Ġ"," ")).classed("matched-cell",e=>e.is_match).classed("next-cell",(function(t){return e.showNext()&&t.is_next_word})).classed("gray-cell",(function(t,s){const a=+X(this);return e.showNext()&&s>a})),this.inspectorCells.each((t,s,a)=>{if(s==X(a[s])){const i=t.inward,n=+o.e(i),r=Y(a[s]),d=e.scaler.domain([0,n]);o.l(`.inspector-row[rownum='${r}']`).selectAll(".inspector-cell").style("background",(e,t)=>Z(d(i[t]))).attr("att",(e,t)=>i[t])}}),e.addTooltip()}updateData(){this.createRows(),this.createCells()}_init(){}_wrangle(e){return this._data=e,e}_render(e){this.updateData()}showNext(e){return null==e?this.options.showNext:(this.options.showNext=e,this)}}J.events={rowMouseOver:"CorpusInspector_rowMouseOver",rowMouseOut:"CorpusInspector_rowMouseOut",rowClick:"CorpusInspector_rowClick",rowDblClick:"CorpusInspector_rowDblClick",cellMouseOver:"CorpusInspector_cellMouseOver",cellMouseOut:"CorpusInspector_cellMouseOut",cellClick:"CorpusInspector_cellClick",cellDblClick:"CorpusInspector_cellDblClick"};const ee=["[CLS]","[SEP]","<s>","</s>","<|endoftext|>"],te=e=>b(e.map(e=>e.text),e=>r.includes(ee,e));class se{constructor(e,t=[[],[]],s=!0){this.nLayers=12,this.nHeads=12,this.init(e,t,s)}init(e,t=[[],[]],s){this.isZeroed=s,this._att=e,this._zeroedAttTensor=function(e,t,s){let a=e.clone(),i=a.bufferSync();return r.range(i.shape[0]).forEach(e=>{r.range(i.shape[1]).forEach(a=>{r.includes(t,a)&&r.range(i.shape[2]).forEach(t=>{i.set(0,e,a,t)}),r.range(i.shape[2]).forEach(t=>{r.includes(s,t)&&r.range(i.shape[1]).forEach(s=>{i.set(0,e,s,t)})})})}),a}(F.b(e),t[0],t[1]),this._attTensor=F.b(e),this.badToks=t}updateFromNormal(e,t){const s=e.aa,a=s.left,i=s.right,n=te(a),o=te(i);this.init(s.att,[n,o],t)}get attTensor(){return this.isZeroed?this._zeroedAttTensor:this._attTensor}get att(){return this.attTensor.arraySync()}zeroed(e){return null==e?this.isZeroed:(this.isZeroed=e,this)}toggleZeroing(){this.zeroed(!this.zeroed())}_byHeads(e){return 0==e.length?F.c(this._byHead(0)):this.attTensor.gather(e,0).sum(0)}_byHead(e){return this.attTensor.gather([e],0).squeeze([0])}byHeads(e){return this._byHeads(e).arraySync()}byHead(e){return this._byHead(e).arraySync()}}var ae=s(93),ie=s(94),ne=s(95),oe=s(114),re=s(96),de=s(97),ce=s(64),le=s(67),he=s(108),ue=s(98),fe=s(111),pe=s(109);const be=["#3957ff","#d3fe14","#c9080a","#fec7f8","#0b7b3e","#0bf0e9","#c203c8","#fd9b39","#888593","#906407","#98ba7f","#fe6794","#10b0ff","#ac7bff","#fee7c0","#964c63","#1da49c","#0ad811","#bbd9fd","#fe6cfe","#297192","#d1a09c","#78579e","#81ffad","#739400","#ca6949","#d9bf01","#646a58","#d5097e","#bb73a9","#ccf6e9","#9cb4b6","#b6a7d4","#9e8c62","#6e83c8","#01af64","#a71afd","#cfe589","#d4ccd1","#fd4109","#bf8f0e","#2f786e","#4ed1a5","#d8bb7d","#a54509","#6a9276","#a4777a","#fc12c9","#606f15","#3cc4d9","#f31c4e","#73616f","#f097c6","#fc8772","#92a6fe","#875b44","#699ab3","#94bc19","#7d5bf0","#d24dfe","#c85b74","#68ff57","#b62347","#994b91","#646b8c","#977ab4","#d694fd","#c4d5b5","#fdc4bd","#1cae05","#7bd972","#e9700a","#d08f5d","#8bb9e1","#fde945","#a29d98","#1682fb","#9ad9e0","#d6cafe","#8d8328","#b091a7","#647579","#1f8d11","#e7eafd","#b9660b","#a4a644","#fec24c","#b1168c","#188cc1","#7ab297","#4468ae","#c949a6","#d48295","#eb6dc2","#d5b0cb","#ff9ffb","#fdb082","#af4d44","#a759c4","#a9e03a","#0d906b","#9ee3bd","#5b8846","#0d8995","#f25c58","#70ae4f","#847f74","#9094bb","#ffe2f1","#a67149","#936c8e","#d04907","#c3b8a6","#cef8c4","#7a9293","#fda2ab","#2ef6c5","#807242","#cb94cc","#b6bdd0","#b5c75d","#fde189","#b7ff80","#fa2d8e","#839a5f","#28c2b5","#e5e9e1","#bc79d8","#7ed8fe","#9f20c3","#4f7a5b","#f511fd","#09c959","#bcd0ce","#8685fd","#98fcff","#afbff9","#6d69b4","#5f99fd","#aaa87e","#b59dfb","#5d809d","#d9a742","#ac5c86","#9468d5","#a4a2b2","#b1376e","#d43f3d","#05a9d1","#c38375","#24b58e","#6eabaf","#66bf7f","#92cbbb","#ddb1ee","#1be895","#c7ecf9","#a6baa6","#8045cd","#5f70f1","#a9d796","#ce62cb","#0e954d","#a97d2f","#fcb8d3","#9bfee3","#4e8d84","#fc6d3f","#7b9fd4","#8c6165","#72805e","#d53762","#f00a1b","#de5c97","#8ea28b","#fccd95","#ba9c57","#b79a82","#7c5a82","#7d7ca4","#958ad6","#cd8126","#bdb0b7","#10e0f8","#dccc69","#d6de0f","#616d3d","#985a25","#30c7fd","#0aeb65","#e3cdb4","#bd1bee","#ad665d","#d77070","#8ea5b8","#5b5ad0","#76655e","#598100","#86757e","#5ea068"];class ge{constructor(){this.colorScale=this.createColorScales()}createColorScales(){const e=e=>{const t=l.a(d.a(String,e),be.slice(0,e.length));return e=>fe.a("black",e,t)};return{pos:e(ge.TotalMetaOptions.pos),dep:e(ge.TotalMetaOptions.dep),is_ent:e(ge.TotalMetaOptions.is_ent),ents:e(ge.TotalMetaOptions.ents),offset:o.i().range(["black"])}}}ge.EnglishMetaOptions={pos:["punct","sym","x","adj","verb","conj","num","et","adv","x","adp","noun","propn","part","pron","space","intj"],dep:["root","ROOT","acl","acomp","advcl","advmod","agent","amod","appos","attr","aux","auxpass","case","cc","ccomp","compound","conj","cop","csubj","csubjpass","dative","dep","det","dobj","expl","intj","mark","meta","neg","nn","nounmod","npmod","nsubj","nsubjpass","nummod","oprd","obj","obl","parataxis","pcomp","pobj","poss","preconj","predet","prep","prt","punct","quantmod","relcl","root","xcomp","npadvmod"],is_ent:[!0,!1],ents:["person","norp","fac","org","gpe","loc","product","event","work_of_art","law","language","date","time","percent","money","quantity","ordinal","cardinal"]},ge.UniversalMetaOptions={pos:["adj","adp","adv","aux","conj","cconj","det","intj","noun","num","part","pron","propn","punct","sconj","sym","verb","x","space"],dep:["acl","advcl","advmod","amod","appos","aux","case","cc","ccomp","clf","compound","conj","cop","csubj","dep","det","discourse","dislocated","expl","fixed","flat","goeswith","iobj","list","mark","nmod","nsubj","nummod","obj","obl","orphan","parataxis","punct","reparandum","root","vocative","xcomp"],is_ent:[!0,!1],ents:["person","norp","fac","org","gpe","loc","product","event","work_of_art","law","language","date","time","percent","money","quantity","ordinal","cardinal"]},ge.TotalMetaOptions={pos:pe.a(ge.EnglishMetaOptions.pos,ge.UniversalMetaOptions.pos),dep:ge.EnglishMetaOptions.dep,is_ent:ge.EnglishMetaOptions.is_ent,ents:ge.EnglishMetaOptions.ents};const me=new ge;class ve extends W{constructor(e,t,s={}){super(e,t),this.css_name="corpus-mat-container",this.options={cellWidth:10,toPick:["pos"],idxs:[-1,0,1],divHover:{width:60,height:40}},this._current={},this.rowCssName="index-match-results",this.cellCssName="index-cell-result",this.idxs=[-1,0,1],this.superInitHTML(s),this._init()}get idxs(){return this.options.idxs}set idxs(e){this.options.idxs=e}_init(){this.corpusMats=this.base.selectAll(".corpus-mat"),this.rowGroups=this.corpusMats.selectAll(`.${this.rowCssName}`),this.divHover=this.base.append("div").classed("mat-hover-display",!0).classed("text-center",!0).style("width",String(this.options.divHover.width)+"px").style("height",String(this.options.divHover.height)+"px"),this.divHover.append("p")}pick(e){this.options.toPick=[e],this.redraw()}addRight(){const e=ae.a(this.idxs)+1;this.idxs.push(e),this.addCorpusMat(e,"right")}addLeft(){const e=this.idxs[0]-1;this.idxs=(e=>ie.a(0,ne.a(e)-1)(e))(this.idxs),this.addCorpusMat(e,"left")}killRight(){this.kill(Math.max(...this.idxs))}killLeft(){this.kill(Math.min(...this.idxs))}kill(e){0!=e&&(e!=Math.min(...this.idxs)&&e!=Math.max(...this.idxs)||(this.idxs=oe.a([e],this.idxs),this.base.selectAll(`.offset-${e}`).remove()))}_wrangle(e){return e}data(e){return null==e?this._data:(this._data=e,this._updateData(),this)}_updateData(){const e=this;this.options;this.base.selectAll(".corpus-mat").remove(),this.idxs.forEach((t,s)=>{e.addCorpusMat(t)})}addCorpusMat(e,t="right"){const s=this,a=this.options,i=a.cellWidth*a.toPick.length,n=re.a(d.a(c.a("height"),this._data));let o;if("right"==t)o=this.base.append("div");else{if("left"!=t)throw Error("toThe must have argument of 'left' or 'right'");o=this.base.insert("div",":first-child")}o=o.data([e]).attr("class",`corpus-mat offset-${e}`).attr("offset",e).append("svg").attrs({width:i,height:n}).on("mouseover",(function(e,t){s.eventHandler.trigger(ve.events.mouseOver,{idx:t,offset:e,val:s.options.toPick[0]})})).on("mouseout",(e,t)=>{this.eventHandler.trigger(ve.events.mouseOut,{idx:t,offset:e})}),this.addRowGroup(o)}addRowGroup(e){const t=this,s=this.options,a=d.a(c.a("height"),this._data),[i,n]=de.a((e,t)=>[ce.a(e,t),ce.a(e,t)],0,a),o=le.a(he.a(1),ue.a(0))(n),r=e.selectAll(`.${t.rowCssName}`).data(e=>(function(e,t=0,s=["pos"]){const a={pos:null,dep:null,is_ent:null,token:null},i=g.a(s);return e.map(e=>{const s=e.index+t;if(s<0||s>=e.tokens.length)return f.a("height",e.height,a);const n=i(e.tokens[s]);return f.a("height",e.height,n)})})(t._data,e,s.toPick)).join("g").attr("class",(e,s)=>`${t.rowCssName} ${t.rowCssName}-${s}`).attr("row-num",(e,t)=>t).attr("height",e=>e.height).attr("transform",(e,t)=>{return $.translate({x:0,y:o[t]})});s.toPick.forEach(e=>{t.addRect(r,0,e)})}addRect(e,t,s){const a=this,i=this.options;e.append("rect").attrs({width:i.cellWidth,height:e=>e.height-3,transform:(e,s)=>$.translate({x:t,y:1.5})}).style("fill",e=>ve.colorScale[s](e[s]));e.on("mouseover",(function(e,t){a.divHover.style("visibility","visible");const s=+o.k(this.parentNode.parentNode).attr("offset");a.eventHandler.trigger(ve.events.rectMouseOver,{idx:t,offset:s})})).on("mouseout",(function(e,t){a.divHover.style("visibility","hidden");const s=+o.k(this.parentNode.parentNode).attr("offset");a.eventHandler.trigger(ve.events.rectMouseOut,{idx:t,offset:s})})).on("mousemove",(function(e,t){const n=o.f(a.base.node()),r=[3,3],d=n[0]+(()=>a.base.node().getBoundingClientRect().left)()-(i.divHover.width+r[0]),c=n[1]+(()=>a.base.node().getBoundingClientRect().top)()-(i.divHover.height+r[1]);a.divHover.style("left",String(d)+"px").style("top",String(c)+"px").selectAll("p").text(e[s])}))}_render(e){this._updateData()}}ve.events={mouseOver:"CorpusMatManager_MouseOver",mouseOut:"CorpusMatManager_MouseOut",click:"CorpusMatManager_Click",dblClick:"CorpusMatManager_DblClick",rectMouseOver:"CorpusMatManager_RectMouseOver",rectMouseOut:"CorpusMatManager_RectMouseOut",rectClick:"CorpusMatManager_RectClick",rectDblClick:"CorpusMatManager_RectDblClick"},ve.colorScale=me.colorScale;var ke=s(99),xe=s(63);ke.a(le.a(e=>{const t=+e;return isNaN(t)?e:t},c.a("label")));const ye=ke.a(c.a("count")),Ce=le.a(xe.a,ye,e=>Object.keys(e).map((t,s)=>({label:t,count:e[t]})));class _e extends W{constructor(e,t,s={}){super(e,t),this.css_name="",this._current={chart:{height:null,width:null}},this.axes={x:o.g(),y:o.h()},this.options={margin:{top:10,right:30,bottom:50,left:40},barWidth:25,width:185,height:230,val:"pos",xLabelRot:45,xLabelOffset:15,yLabelOffset:5},this.superInitSVG()}meta(e){return null==e?this.options.val:(this.options.val=e,this.update(this._data),this)}_init(){}createXAxis(){const e=this.options,t=e.width-e.margin.left-e.margin.right;this.axes.x.domain(d.a(c.a("label"),this.renderData)).rangeRound([0,t]).padding(.1),this._current.chart.width=t}createYAxis(){const e=this.options,t=e.height-e.margin.top-e.margin.bottom;this.axes.y.domain([0,+o.e(d.a(c.a("count"),this.renderData))]).rangeRound([t,0]),this._current.chart.height=t}createAxes(){this.createXAxis(),this.createYAxis()}_wrangle(e){const t=e[this.options.val];return Ce(t)}width(e){return null==e?this.options.width:(this.options.width=e,this.updateWidth(),this.createXAxis(),this)}height(e){return null==e?this.options.height:(this.options.height=e,this.updateHeight(),this.createYAxis(),this)}updateWidth(){this.svg.attr("width",this.options.width)}updateHeight(){this.svg.attr("height",this.options.height)}figWidth(e){const t=this.options;return e.length*t.barWidth+t.margin.left+t.margin.right}_render(e){const t=this,s=this.options,a=this._current;this.parent.html(""),this.svg=this.parent,this.createAxes(),this.width(this.figWidth(e)),this.updateHeight();const i=t.svg.append("g").attr("transform",$.translate({x:s.margin.left,y:s.margin.top}));t.base=i;const n=i.append("g").attr("transform",$.translate({x:0,y:a.chart.height})).call(o.a(t.axes.x));"offset"!=s.val&&n.selectAll("text").attr("y",s.yLabelOffset).attr("x",s.xLabelOffset).attr("transform",$.rotate(s.xLabelRot)),i.append("g").call(o.b(t.axes.y)),i.selectAll(".bar").data(e).join("rect").attr("class","bar").attr("x",(function(e){return t.axes.x(e.label)})).attr("y",(function(e){return t.axes.y(e.count)})).attr("width",t.axes.x.bandwidth()).attr("height",(function(e){return a.chart.height-t.axes.y(e.count)})).style("fill",e=>me.colorScale[s.val](e.label))}}_e.events={};var we=s(101),Me=s(102),Se=s(103),He=s(68),Ie=s(104);const je=h.a((e,t)=>l.a(t,d.a(e,t)))(e=>0),Ae=we.a(Me.a(String),Se.a,He.a);class Oe{constructor(e,t=!1){this.options={showNext:!1},this.data=e,this.options.showNext=t}get matchAtt(){return this.showNext()?"matched_att_plus_1":"matched_att"}get matchIdx(){return this.showNext()?"next_index":"index"}countPosInfo(){const e=this.data.map((e,t)=>+e[this.matchAtt].out.offset_to_max),t={offset:je(e)};return e.forEach(e=>{Object.keys(t).forEach(s=>{t[s][e]+=1})}),t}countMaxAttKeys(e=0){const t={pos:je(ge.TotalMetaOptions.pos),dep:je(ge.TotalMetaOptions.dep),is_ent:je(ge.TotalMetaOptions.is_ent)};return this.data.forEach((e,s)=>{const a=(e=>e.tokens[function(e){return[].map.call(e,(e,t)=>[e,t]).reduce((e,t)=>t[0]>e[0]?t:e)[1]}(e.matched_att.out.att)])(e);Object.keys(t).forEach(e=>{const s=Ae(String(a[e]));t[e][s]+=1})}),Object.assign(t,this.countPosInfo())}countMatchedKeys(e=0){const t={pos:je(ge.TotalMetaOptions.pos),dep:je(ge.TotalMetaOptions.dep),is_ent:je(ge.TotalMetaOptions.is_ent)};return this.data.forEach(s=>{const a=s.tokens[s[this.matchIdx]+e];Object.keys(t).forEach(e=>{const s=Ae(String(a[e]));t[e][s]+=1})}),t}getMatchedHistogram(e=0){const t=this.countMatchedKeys(e);return d.a(Ie.a((e,t)=>0!=e),t)}getMaxAttHistogram(){const e=this.countMaxAttKeys();return d.a(Ie.a((e,t)=>0!=e),e)}showNext(e){return null==e?this.options.showNext:(this.options.showNext=e,this)}}var Te=s(106),De=s(65),Ee=s(107),Re=s(51),Ne=s(110);function Le(e){const t=e=>null==e||"null"==e,s=null==e,a=t(e.side)||t(e.ind);return s||a}function ze(e){if(!Le(e)){const t="left"==e.side?"src-idx":"target-idx";L.setHidden(".atn-curve"),L.setVisible(`.atn-curve[${t}='${e.ind}']`)}}function $e(e){o.l(`.att-rect[head='${e}']`).classed("unselected",!0)}function We(e){o.l(`.att-rect[head='${e}']`).classed("unselected",!1)}function Ue(e,t){const s=!!e||null;t.attr("disabled",s)}class Be{constructor(){this.api=new j,this.uiConf=new D,this.skeletonInit(),this.mainInit()}skeletonInit(){this.sels={body:o.k("body"),atnContainer:o.k("#atn-container"),atnDisplay:o.k("#atn-display"),modelSelector:o.k("#model-option-selector"),corpusSelector:o.k("#corpus-select"),atnHeads:{left:o.k("#left-att-heads"),right:o.k("#right-att-heads"),headInfo:o.k("#head-info-box").classed("mat-hover-display",!0).classed("text-center",!0).style("width",String(70)+"px").style("height",String(30)+"px").style("visibillity","hidden")},form:{sentenceA:o.k("#form-sentence-a"),button:o.k("#update-sentence")},tokens:{left:o.k("#left-tokens"),right:o.k("#right-tokens")},clsToggle:o.k("#cls-toggle").select(".switch"),layerCheckboxes:o.k("#layer-select"),headCheckboxes:o.k("#head-select"),contextQuery:o.k("#search-contexts"),embeddingQuery:o.k("#search-embeddings"),selectedHeads:o.k("#selected-heads"),headSelectAll:o.k("#select-all-heads"),headSelectNone:o.k("#select-no-heads"),testCheckbox:o.k("#simple-embed-query"),threshSlider:o.k("#my-range"),corpusInspector:o.k("#corpus-similar-sentences-div"),corpusMatManager:o.k("#corpus-mat-container"),corpusMsgBox:o.k("#corpus-msg-box"),histograms:{matchedWordDescription:o.k("#match-kind"),matchedWord:o.k("#matched-histogram-container"),maxAtt:o.k("#max-att-histogram-container")},buttons:{killLeft:o.k("#kill-left"),addLeft:o.k("#minus-left"),addRight:o.k("#plus-right"),killRight:o.k("#kill-right"),refresh:o.k("#mat-refresh")},metaSelector:{matchedWord:o.k("#matched-meta-select"),maxAtt:o.k("#max-att-meta-select")}},this.eventHandler=new z(this.sels.body.node()),this.vizs={leftHeads:new G(this.sels.atnHeads.left,this.eventHandler,{side:"left"}),rightHeads:new G(this.sels.atnHeads.right,this.eventHandler,{side:"right"}),tokens:{left:new B(this.sels.tokens.left,this.eventHandler),right:new P(this.sels.tokens.right,this.eventHandler)},attentionSvg:new Q(this.sels.atnDisplay,this.eventHandler),corpusInspector:new J(this.sels.corpusInspector,this.eventHandler),corpusMatManager:new ve(this.sels.corpusMatManager,this.eventHandler,{idxs:this.uiConf.offsetIdxs()}),histograms:{matchedWord:new _e(this.sels.histograms.matchedWord,this.eventHandler),maxAtt:new _e(this.sels.histograms.maxAtt,this.eventHandler)}},this._bindEventHandler(),this._initModelSelection(),this._initCorpusSelection()}mainInit(){const e=this;this.sels.body.style("cursor","progress"),this.api.getModelDetails(this.uiConf.model()).then(t=>{const s=t.payload;this.uiConf.nLayers(s.nlayers).nHeads(s.nheads),this.initLayers(this.uiConf.nLayers()),this.api.getMetaAttentions(this.uiConf.model(),this.uiConf.sentence(),this.uiConf.layer()).then(t=>{const s=t.payload;this.initFromResponse(s);const a=()=>{this._toggleTokenSel();const e=this.uiConf.displayInspector();this._searchDisabler(),"context"==e?this._queryContext():"embeddings"==e&&this._queryEmbeddings()};let o;o=this.uiConf.modelKind()!=n.Autoregressive||this.uiConf.hideClsSep()?i.All:i.Col,this.vizs.attentionSvg.normBy=o,this.uiConf.maskInds().length>0?(this.tokCapsule.a.maskInds=this.uiConf.maskInds(),this.api.updateMaskedAttentions(this.uiConf.model(),this.tokCapsule.a,this.uiConf.sentence(),this.uiConf.layer()).then(e=>{const t=e.payload;this.attCapsule.updateFromNormal(t,this.uiConf.hideClsSep()),this.tokCapsule.updateTokens(t),this.update(),a()})):(this.update(),a()),this.uiConf.modelKind()==n.Autoregressive?(this.uiConf.hasToken()&&this.grayToggle(this.uiConf.token().ind),e.vizs.tokens.left.options.divHover.textInfo="Would predict next...",e.vizs.tokens.right.options.divHover.textInfo="Would predict next..."):(e.vizs.tokens.left.options.divHover.textInfo="Would predict here...",e.vizs.tokens.right.options.divHover.textInfo="Would predict here..."),this.sels.body.style("cursor","default")})})}initFromResponse(e){this.attCapsule=function(e,t){const s=e.aa,a=s.left,i=s.right,n=b(a.map(e=>e.text),e=>r.includes(ee,e)),o=b(i.map(e=>e.text),e=>r.includes(ee,e));return new se(s.att,[n,o],t)}(e,this.uiConf.hideClsSep()),this.tokCapsule=new x(e),this._staticInits()}leaveCorpusMsg(e){this.vizs.corpusInspector.hideView(),this.vizs.corpusMatManager.hideView(),console.log("Running leave msg"),L.unhideElement(this.sels.corpusMsgBox),this.sels.corpusMsgBox.text(e)}_bindEventHandler(){const e=this;this.eventHandler.bind(U.events.tokenDblClick,t=>{switch(e.uiConf.modelKind()){case n.Bidirectional:{t.sel.classed("masked-token",!t.sel.classed("masked-token"));const s=function(e,t){return"all"==t?"all":"left"==e?t[0]:t[1]}(t.side,this.uiConf.attType);e.tokCapsule[s].toggle(t.ind),e.sels.body.style("cursor","progress"),e.api.updateMaskedAttentions(this.uiConf.model(),this.tokCapsule.a,this.uiConf.sentence(),this.uiConf.layer()).then(t=>{const s=t.payload;e.attCapsule.updateFromNormal(s,this.uiConf.hideClsSep()),e.tokCapsule.updateTokens(s),e.uiConf.maskInds(this.tokCapsule.a.maskInds),e.update(),e.sels.body.style("cursor","default")});break}case n.Autoregressive:console.log("Autoregressive model doesn't do masking");break;default:console.log("What kind of model is this?")}}),this.eventHandler.bind(U.events.tokenMouseOver,e=>{!function(e,t){Le(e)&&ze(t)}(this.uiConf.token(),e)}),this.eventHandler.bind(U.events.tokenMouseOut,e=>{!function(e){Le(e)&&L.setVisible(".atn-curve")}(this.uiConf.token())}),this.eventHandler.bind(U.events.tokenClick,e=>{(()=>{this.uiConf.toggleToken(e),this._toggleTokenSel(),ze(e)})(),this.renderAttHead()}),this.eventHandler.bind(G.events.rowMouseOver,t=>{e.sels.atnHeads.headInfo.style("visibility","visible")}),this.eventHandler.bind(G.events.rowMouseOut,()=>{e.sels.atnHeads.headInfo.style("visibility","hidden")}),this.eventHandler.bind(G.events.boxMouseOver,e=>{const t=this.attCapsule.byHead(e.head);this.vizs.attentionSvg.data(t),this.vizs.attentionSvg.update(t),ze(this.uiConf.token())}),this.eventHandler.bind(G.events.boxMouseOut,()=>{const e=this.attCapsule.byHeads(this.uiConf.heads());this.vizs.attentionSvg.data(e),this.vizs.attentionSvg.update(e),ze(this.uiConf.token())}),this.eventHandler.bind(G.events.boxMouseMove,t=>{const s=e.sels.atnHeads.headInfo;let a,i,n;if("left"==t.side){const e=[12,3];a=t.mouse[0]+t.baseX-(+s.style("width").replace("px","")+e[0]),i=t.mouse[1]+t.baseY-(+s.style("height").replace("px","")+e[1]),n="8px 8px 1px 8px"}else{const e=[-13,3];a=t.mouse[0]+t.baseX+e[0],i=t.mouse[1]+t.baseY-(+s.style("height").replace("px","")+e[1]),n="8px 8px 8px 1px"}s.style("visibility","visible").style("left",String(a)+"px").style("top",String(i)+"px").style("border-radius",n).text(`Head: ${t.ind+1}`)}),this.eventHandler.bind(G.events.boxClick,e=>{const t=this.uiConf.toggleHead(e.head);t==a.ADDED?We(e.head):t==a.REMOVED&&$e(e.head),this._searchDisabler(),this._renderHeadSummary(),this.renderSvg()}),this.eventHandler.bind(ve.events.mouseOver,e=>{}),this.eventHandler.bind(ve.events.mouseOut,e=>{}),this.eventHandler.bind(ve.events.rectMouseOver,e=>{o.k(`.inspector-row[rownum='${e.idx}']`).select(`.inspector-cell[index-offset='${e.offset}']`).classed("hovered-col",!0)}),this.eventHandler.bind(ve.events.rectMouseOut,e=>{o.k(`.inspector-row[rownum='${e.idx}']`).select(`.inspector-cell[index-offset='${e.offset}']`).classed("hovered-col",!1)})}_toggleTokenSel(){const e=this.uiConf.token(),t=o.k(".selected-token");if(this.uiConf.hasToken()){const t=e=>`#${e.side}-token-${e.ind}`,s=o.k(t(e));s.empty()||s.classed("selected-token",!0)}else{const e=o.l(".selected-token");e.empty()||e.classed("selected-token",!1)}t.empty()||t.classed("selected-token",!1),this.uiConf.modelKind()==n.Autoregressive&&(this.grayToggle(+e.ind),this.markNextToggle(+e.ind,this.tokCapsule.a.length())),this._searchDisabler()}grayBadToks(e){if(this.uiConf.modelKind()==n.Autoregressive){const t=function(t,s){o.k(this).classed("masked-token",s>e)};o.l(".right-token").each(t),o.l(".left-token").each(t)}}grayToggle(e){this.uiConf.hasToken()?this.grayBadToks(e):o.l(".token").classed("masked-token",!1)}markNextWordToks(e,t){const s=function(s,a){o.k(this).classed("next-token",a==Math.min(e+1,t))};o.l(".right-token").each(s),o.l(".left-token").each(s)}markNextToggle(e,t){this.uiConf.hasToken()?this.markNextWordToks(e,t):o.l(".token").classed("next-token",!1)}_initModelSelection(){const e=this;this.api.getSupportedModels().then(t=>{const s=t.descriptions;t.force&&(this.uiConf.model(s[0].name),this.uiConf.modelKind(s[0].kind));const a=d.a(c.a("name"))(s),i=d.a(c.a("kind"))(s),r=l.a(a,i);this.sels.modelSelector.selectAll(".model-option").data(s).join("option").classed("model-option",!0).property("value",e=>e.name).attr("modelkind",e=>e.kind).text(e=>e.name),this.sels.modelSelector.property("value",this.uiConf.model()),this.sels.modelSelector.on("change",(function(){const t=o.k(this).property("value");e.uiConf.model(t),e.uiConf.modelKind(r[t]),r[t]==n.Autoregressive&&(console.log("RESETTING MASK INDS"),e.uiConf.maskInds([])),e.mainInit()}))})}_initCorpusSelection(){const e=this;this.api.getSupportedCorpora().then(t=>{e.uiConf.corpus(t[0].code),e.sels.corpusSelector.selectAll("option").data(t).join("option").property("value",e=>e.code).text(e=>e.display),this.sels.corpusSelector.on("change",(function(){const t=o.k(this);e.uiConf.corpus(t.property("value")),console.log(e.uiConf.corpus())}))})}_staticInits(){this._initSentenceForm(),this._initQueryForm(),this._initAdder(),this._renderHeadSummary(),this._initMetaSelectors(),this._initToggle(),this.renderAttHead(),this.renderTokens()}_initAdder(){const e=()=>{this.uiConf.offsetIdxs(this.vizs.corpusMatManager.idxs)},t=()=>{const t=this._wrapResults(this.vizs.corpusMatManager.data());this.vizs.corpusMatManager.data(t.data),e()};this.sels.buttons.addRight.on("click",()=>{this.vizs.corpusMatManager.addRight(),e()}),this.sels.buttons.addLeft.on("click",()=>{this.vizs.corpusMatManager.addLeft(),e()}),this.sels.buttons.killRight.on("click",()=>{this.vizs.corpusMatManager.killRight(),e()}),this.sels.buttons.killLeft.on("click",()=>{this.vizs.corpusMatManager.killLeft(),e()}),this.sels.buttons.refresh.on("click",()=>{t()});window.onresize=()=>{""!=this.sels.corpusInspector.text()&&t()}}_initMetaSelectors(){this._initMatchedWordSelector(this.sels.metaSelector.matchedWord),this._initMaxAttSelector(this.sels.metaSelector.maxAtt)}_initMaxAttSelector(e){const t=this;var s;s=this.uiConf.metaMax(),e.selectAll("label").classed("active",!1),e.selectAll(`label[value=${s}]`).classed("active",!0),e.selectAll("label").on("click",(function(){const s=o.k(this).attr("value");e.selectAll(".active").classed("active",!1),o.k(this).classed("active",!0),t.uiConf.metaMax(s),t.vizs.histograms.maxAtt.meta(s)}))}_initMatchedWordSelector(e){const t=this;var s;s=this.uiConf.metaMatch(),e.selectAll("label").classed("active",!1),e.selectAll(`label[value=${s}]`).classed("active",!0),e.selectAll("label").on("click",(function(){const s=o.k(this).attr("value");e.selectAll(".active").classed("active",!1),o.k(this).classed("active",!0),t.uiConf.metaMatch(s),t._updateCorpusInspectorFromMeta(s)}))}_disableSearching(e){Ue(e,this.sels.contextQuery),Ue(e,this.sels.embeddingQuery)}_updateCorpusInspectorFromMeta(e){this.vizs.corpusInspector.showNext(this.uiConf.showNext),this.vizs.corpusMatManager.pick(e),this.vizs.histograms.matchedWord.meta(e)}_initSentenceForm(){const e=this;this.sels.form.sentenceA.attr("placeholder","Enter new sentence to analyze"),this.sels.form.sentenceA.attr("value",this.uiConf.sentence());const t=()=>{const t=this.sels.form.sentenceA.property("value").replace(/\#/g,"");t.length&&(this.sels.body.style("cursor","progress"),this.api.getMetaAttentions(this.uiConf.model(),t,this.uiConf.layer()).then(s=>{const a=s.payload;this.uiConf.sentence(t),this.uiConf.rmToken(),this.attCapsule.updateFromNormal(a,this.uiConf.hideClsSep()),this.tokCapsule.updateFromResponse(a),this._toggleTokenSel(),this.update(),e.vizs.corpusMatManager.clear(),e.vizs.corpusInspector.clear(),e.vizs.histograms.matchedWord.clear(),e.vizs.histograms.maxAtt.clear(),this.sels.body.style("cursor","default")}))},s=h.a((e,t,s)=>{const a=s||window.event;a.keyCode===e&&(a.preventDefault(),t())})(13,t),a=this.sels.form.button,i=this.sels.form.sentenceA;a.on("click",t),i.on("keypress",s)}_getSearchEmbeds(){const e=this.uiConf.token();return this.vizs.tokens[e.side].getEmbedding(e.ind).embeddings}_getSearchContext(){const e=this.uiConf.token();return this.vizs.tokens[e.side].getEmbedding(e.ind).contexts}_searchEmbeddings(){const e=this;console.log("SEARCHING EMBEDDINGS");const t=this._getSearchEmbeds(),s=e.uiConf.layer(),a=e.uiConf.heads();e.vizs.corpusInspector.showNext(e.uiConf.showNext),this.sels.body.style("cursor","progress"),e.api.getNearestEmbeddings(e.uiConf.model(),e.uiConf.corpus(),t,s,a,50).then(t=>{if(406==t.status)e.leaveCorpusMsg(`Embeddings are not available for model '${e.uiConf.model()}' and corpus '${e.uiConf.corpus()}' at this time.`);else{const s=t.payload;e.vizs.corpusInspector.unhideView(),e.vizs.corpusMatManager.unhideView(),e.vizs.corpusInspector.update(s);const a=e._wrapResults(s),i=a.getMatchedHistogram(),n=a.getMaxAttHistogram();e.vizs.corpusMatManager.update(a.data),e.sels.histograms.matchedWordDescription.text(this.uiConf.matchHistogramDescription),console.log("MATCHER: ",e.sels.histograms.matchedWord),e.vizs.histograms.matchedWord.update(i),e.vizs.histograms.maxAtt.update(n),e.uiConf.displayInspector("embeddings"),this._updateCorpusInspectorFromMeta(this.uiConf.metaMatch())}this.sels.body.style("cursor","default")})}_searchContext(){const e=this;console.log("SEARCHING CONTEXTS");const t=this._getSearchContext(),s=e.uiConf.layer(),a=e.uiConf.heads();e.vizs.corpusInspector.showNext(e.uiConf.showNext),this.sels.body.style("cursor","progress"),e.api.getNearestContexts(e.uiConf.model(),e.uiConf.corpus(),t,s,a,50).then(t=>{if(406==t.status)console.log("Contexts are not available!"),e.leaveCorpusMsg(`Contexts are not available for model '${e.uiConf.model()}' and corpus '${e.uiConf.corpus()}' at this time.`);else{const s=t.payload;console.log("HIDING"),e.vizs.corpusInspector.update(s),L.hideElement(e.sels.corpusMsgBox),e.vizs.corpusInspector.unhideView(),e.vizs.corpusMatManager.unhideView();const a=e._wrapResults(s),i=a.getMatchedHistogram(),n=a.getMaxAttHistogram();e.vizs.corpusMatManager.update(a.data),e.vizs.histograms.matchedWord.update(i),e.vizs.histograms.maxAtt.update(n),e.uiConf.displayInspector("context"),this._updateCorpusInspectorFromMeta(this.uiConf.metaMatch()),e.vizs.histograms.maxAtt.meta(e.uiConf.metaMax())}this.sels.body.style("cursor","default")})}_queryContext(){this.uiConf.hasToken()?this._searchContext():console.log("Was told to show inspector but was not given a selected token embedding")}_queryEmbeddings(){this.uiConf.hasToken()?(console.log("token: ",this.uiConf.token()),this._searchEmbeddings()):console.log("Was told to show inspector but was not given a selected token embedding")}_searchingDisabled(){return 0==this.uiConf.heads().length||!this.uiConf.hasToken()}_searchDisabler(){this._disableSearching(this._searchingDisabled())}_initQueryForm(){const e=this;this._searchDisabler(),this.sels.contextQuery.on("click",()=>{e._queryContext()}),this.sels.embeddingQuery.on("click",()=>{e._queryEmbeddings()})}_renderHeadSummary(){this.sels.selectedHeads.html(u.a(", ",this.uiConf.heads().map(e=>e+1)))}_wrapResults(e){const t=o.l(".inspector-row").nodes().map(e=>e.getBoundingClientRect().height),s=e.map((e,s)=>f.a("height",t[s],e));return new Oe(s,this.uiConf.showNext)}initLayers(e){const t=this;let s=!1;const a=t.sels.layerCheckboxes.selectAll(".layerCheckbox").data(r.range(0,e)).join("label").attr("class","btn button layerCheckbox").classed("active",(a,i)=>a==t.uiConf.layer()?(s=!0,!0):!s&&a==e&&(t.uiConf.layer(a),s=!0,!0)).text(e=>e+1).append("input").attr("type","radio").attr("class","checkbox-inline").attr("name","layerbox").attr("id",(e,t)=>"layerCheckbox"+t);Object(Te.a)(a.nodes(),"change").pipe(Object(Ee.a)(e=>{const t=o.k(e.target).datum();console.log(t,"--- myData"),this.sels.layerCheckboxes.selectAll(".layerCheckbox").classed("active",e=>e===t)}),Object(Re.a)(e=>+o.k(e.target).datum()),Object(Ee.a)(e=>{console.log("New layer: ",e),t.uiConf.layer(e),t.sels.body.style("cursor","progress")}),Object(Ne.a)(e=>Object(De.a)(t.api.updateMaskedAttentions(t.uiConf.model(),t.tokCapsule.a,t.uiConf.sentence(),e)))).subscribe({next:e=>{const s=e.payload;t.attCapsule.updateFromNormal(s,this.uiConf.hideClsSep()),t.tokCapsule.updateTokens(s),t.uiConf.maskInds(t.tokCapsule.a.maskInds),t.update(),t.sels.body.style("cursor","default"),t._toggleTokenSel()}});const i=`#layerCheckbox${this.uiConf.layer()}`;console.log("Layer ID: ",i),o.k(i).attr("checked","checked");const n=e=>Math.round(100*e);o.k("#my-range-value").text(n(t.uiConf.threshold())),this.sels.threshSlider.on("input",r.throttle((function(){t.uiConf.threshold(+this.value/100),o.k("#my-range-value").text(n(t.uiConf.threshold())),t.vizs.attentionSvg.threshold(t.uiConf.threshold())}),100)),this.sels.headSelectAll.on("click",(function(){t.uiConf.selectAllHeads(),t._searchDisabler(),t.renderSvg(),t.renderAttHead()})),this.sels.headSelectNone.on("click",(function(){t.uiConf.selectNoHeads(),t._searchDisabler(),t.renderSvg(),t.renderAttHead(),L.setHidden(".atn-curve")}))}_initToggle(){Object(Te.a)(this.sels.clsToggle.node(),"input").pipe(Object(Re.a)(e=>e.srcElement.checked)).subscribe({next:e=>{this.uiConf.hideClsSep(e),this.attCapsule.zeroed(e),this.renderSvg(),this.renderAttHead()}})}renderAttHead(){const e=r.range(0,this.uiConf._nHeads),t=this.attCapsule.att,s=this.uiConf.hasToken()?this.uiConf.token():null,a=V(t,e,"left",s),i=V(t,e,"right",s);this.vizs.leftHeads.options.offset=this.uiConf.offset,this.vizs.leftHeads.update(a),this.vizs.rightHeads.update(i),this._renderHeadSummary(),e.forEach(e=>{this.uiConf.headSet().has(e)?We(e):$e(e)})}renderTokens(){const e=this.tokCapsule[this.uiConf.attType[0]],t=this.tokCapsule[this.uiConf.attType[1]];console.log("now: ",this.uiConf.offset),this.vizs.tokens.left.options.offset=this.uiConf.offset,this.vizs.tokens.left.update(e.tokenData),this.vizs.tokens.left.mask(e.maskInds),this.vizs.tokens.right.update(t.tokenData),this.vizs.tokens.right.mask(t.maskInds)}renderSvg(){const e=this.attCapsule.byHeads(this.uiConf.heads());this.vizs.attentionSvg.options.offset=this.uiConf.offset;const t=this.vizs.attentionSvg.data(e);t.update(e);const s=r.max([this.tokCapsule.a.length()]),a=t.options.boxheight*s;t.height(a),ze(this.uiConf.token())}render(){this.renderTokens(),this.renderSvg(),this.renderAttHead()}update(){this.render()}}s(82),s(83),s(84);window.onload=()=>{new Be,console.log("Done loading window")}}});